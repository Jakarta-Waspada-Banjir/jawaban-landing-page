import L from "leaflet";
import { Marker, Popup } from "react-leaflet";

import { FloodIcon } from "@/components/icons";
import { Card, CardContent, CardHeader } from "@/components/ui";
import { initialObservationPost } from "@/data/FloodInformationMap";
import { formatDate } from "@/utils";

import { StatusBadge } from "../StatusBadge";

const markerObservationPost = L.divIcon({
  html: `<svg width="25" height="37" viewBox="0 0 34 46" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clipPath="url(#clip0_2008_1167)">
<circle cx="17.5" cy="15.5" r="9.5" fill="#FFA40B" />
<path d="M17 0.5C12.6239 0.5 8.42709 2.23839 5.33274 5.33274C2.23839 8.42709 0.5 12.6239 0.5 17C0.5 25.715 15.2 44.15 15.83 44.945C15.9706 45.1202 16.1487 45.2616 16.3512 45.3587C16.5537 45.4559 16.7754 45.5063 17 45.5063C17.2246 45.5063 17.4463 45.4559 17.6488 45.3587C17.8513 45.2616 18.0294 45.1202 18.17 44.945C18.8 44.15 33.5 25.715 33.5 17C33.5 12.6239 31.7616 8.42709 28.6673 5.33274C25.5729 2.23839 21.3761 0.5 17 0.5ZM17 24.5C15.22 24.5 13.4799 23.9722 11.9999 22.9832C10.5198 21.9943 9.36627 20.5887 8.68509 18.9442C8.0039 17.2996 7.82567 15.49 8.17293 13.7442C8.5202 11.9984 9.37737 10.3947 10.636 9.13604C11.8947 7.87737 13.4984 7.0202 15.2442 6.67293C16.99 6.32567 18.7996 6.5039 20.4442 7.18508C22.0887 7.86627 23.4943 9.01983 24.4832 10.4999C25.4722 11.9799 26 13.72 26 15.5C26 17.8869 25.0518 20.1761 23.364 21.864C21.6761 23.5518 19.3869 24.5 17 24.5Z" fill="#FFA40B" />
<path d="M17 0.5V6.5V11C17 11 17 12.6131 17 15C17 17.3869 17.0002 18.5 17.0002 21C16.9998 23 17 23 17 24.5V45.5C17.2253 45.499 17.4475 45.4472 17.65 45.3485C17.8526 45.2498 18.0303 45.1068 18.17 44.93C18.8 44.15 33.5 25.715 33.5 17C33.5 12.6239 31.7616 8.42709 28.6673 5.33274C25.5729 2.23839 21.3761 0.5 17 0.5Z" fill="#EB9504" />
<path fillRule="evenodd" clipRule="evenodd" d="M27.5797 20.9202C27.4783 19.804 26.9709 18.857 26.0577 18.1467C25.5841 17.7408 25.1444 17.4702 24.5694 17.3349C22.3709 16.8614 19.9018 17.8423 19.2591 20.007C18.8871 21.2246 19.1915 22.6452 20.0371 23.6599C21.593 25.5202 24.5018 25.6893 26.2606 24.1673C27.1739 23.3893 27.6812 22.1378 27.5797 20.9202ZM18.6165 20.4805C18.6503 20.2775 18.6841 20.0746 18.7518 19.8717C19.0224 19.0261 19.5297 18.3158 20.2062 17.7746C18.4474 16.8614 16.2489 16.8614 14.49 17.7408C15.3694 18.4849 15.9106 19.3981 16.0797 20.4805C16.8915 20.3114 17.7709 20.3114 18.6165 20.4805ZM11.5474 25.1481C15.5047 25.0805 17.0606 20.4128 14.118 18.079C13.6106 17.707 13.1709 17.4025 12.6297 17.2673C10.465 16.7937 7.99591 17.7746 7.31944 19.9393C7.28945 20.0375 7.26385 20.137 7.24258 20.2374C7.18481 20.655 7.16749 21.089 7.19946 21.5421C7.3003 22.2828 7.60833 23.0054 8.09738 23.5923C8.90915 24.607 10.1944 25.182 11.5474 25.1481ZM23.2165 13.3099C22.7091 12.0923 22.1341 11.179 20.8489 11.4834C20.4009 11.5852 20.2349 11.7116 20.0851 11.8255C19.9861 11.9008 19.8942 11.9708 19.7327 12.0246V13.8511C20.815 13.2084 22.0327 13.0055 23.2165 13.3099ZM18.718 11.5511C18.5489 11.1114 17.94 10.9761 17.4665 10.9761C16.79 11.0099 16.3165 11.2467 16.1474 11.6187C17.0268 11.5173 17.8724 11.5173 18.718 11.5511ZM16.9595 12.7345C16.9509 12.5291 16.942 12.3154 16.9591 12.0584C15.7753 12.1261 15.3018 12.2275 15.3018 12.2614C15.2708 12.6029 15.2255 12.923 15.1823 13.2283C15.1313 13.5882 15.0833 13.9275 15.065 14.257C15.0456 14.2764 15.0373 14.2847 15.0338 14.2946C15.0312 14.302 15.0312 14.3102 15.0312 14.3246C15.1665 14.3922 15.3018 14.4937 15.4371 14.5952L15.4371 14.5952C15.5386 14.6628 15.6062 14.6967 15.7077 14.6967C16.1474 14.6967 16.6547 14.6628 17.162 14.629L17.1621 14.629C18.4507 14.5431 18.6893 14.5936 18.8476 14.5033C18.9386 14.4514 19.0031 14.353 19.2253 14.1555V12.0584C18.6503 12.0246 18.0415 12.0246 17.4665 12.0246C17.4496 12.2783 17.458 12.4897 17.4665 12.7011C17.475 12.9125 17.4834 13.1239 17.4665 13.3775C17.4665 13.5128 17.365 13.6143 17.2297 13.6143C17.0606 13.6143 16.9591 13.479 16.9591 13.3437C16.9758 13.1268 16.9678 12.9345 16.9595 12.7345ZM14.3564 11.839C14.2212 11.7407 14.0988 11.6517 14.0165 11.6187C13.0356 11.179 12.2239 11.5173 11.7503 12.4981C11.5812 12.8364 11.4797 13.2084 11.3783 13.5805L11.3783 13.5805C12.5283 13.4452 13.6106 13.6143 14.5577 14.0878C14.5872 13.7777 14.6296 13.487 14.6709 13.2043C14.7241 12.8395 14.7754 12.4882 14.7944 12.1261C14.6556 12.0566 14.4989 11.9427 14.3564 11.839ZM10.9386 14.1217C10.8371 14.1555 10.7018 14.2231 10.6341 14.3246C9.92385 15.204 9.21356 16.3878 8.60474 17.504C9.68709 16.7937 11.2091 16.4893 12.7312 16.8275C13.2386 16.929 13.6444 17.1658 14.0503 17.4364C16.0797 16.3202 18.6503 16.354 20.6797 17.4702C21.7621 16.8275 23.2165 16.5231 24.6709 16.8614C25.2121 16.9967 25.618 17.2334 26.0577 17.5378C25.7249 17.0026 25.4231 16.523 25.1364 16.0673C24.7527 15.4577 24.396 14.8908 24.0283 14.2908C23.9606 14.1893 23.893 14.1217 23.7915 14.0878C22.3033 13.3775 20.6121 13.682 19.2591 14.832C19.09 14.9673 18.8871 15.0687 18.6503 15.0687C18.3272 15.0811 17.9631 15.1027 17.5863 15.125C16.9376 15.1634 16.2516 15.204 15.6739 15.204C15.4709 15.204 15.268 15.1364 15.0989 15.0011C13.9827 14.1217 12.4944 13.8173 10.9386 14.1217ZM23.4533 24.2011C21.2886 24.2349 19.7327 22.2393 20.3077 20.3114C20.815 18.6878 22.6077 17.9437 24.1974 18.282C24.6709 18.4173 25.043 18.654 25.3474 18.8908C27.5797 20.6496 26.3621 24.1673 23.4533 24.2011ZM21.2886 22.7467C22.3033 23.9305 24.1297 23.9643 25.1783 23.0511C26.2606 22.104 26.3621 20.3114 25.0768 19.3305L25.0069 19.2814C24.7005 19.0661 24.4444 18.8861 24.1297 18.8231C22.7768 18.5187 21.2209 19.1275 20.815 20.4805C20.5783 21.2246 20.7474 22.1378 21.2886 22.7467ZM11.5474 24.2349C9.28121 24.3025 7.6915 22.2055 8.30032 20.2437C8.80768 18.5525 10.668 17.8084 12.3591 18.1805C12.7989 18.282 13.1371 18.4849 13.5091 18.7893C15.8091 20.582 14.5577 24.2011 11.5474 24.2349ZM8.77385 20.379C8.2665 22.0364 9.61944 23.7614 11.5136 23.7275C14.0503 23.6937 15.0989 20.6834 13.2047 19.1614L13.1424 19.1176C12.8325 18.8999 12.5728 18.7175 12.2239 18.654C10.8033 18.3496 9.17974 18.9923 8.77385 20.379ZM16.6886 19.4996C16.3503 19.229 16.2489 18.6878 16.4518 18.3158C16.79 17.6393 17.7709 17.6055 18.1091 18.3158C18.3121 18.7217 18.1768 19.229 17.8724 19.4996C17.568 19.7702 17.0268 19.7702 16.6886 19.4996ZM24.6033 22.2393C25.2121 21.6981 25.3474 20.7172 24.9077 20.0408C24.84 19.9393 24.6709 19.9055 24.5694 19.9731C24.468 20.0408 24.4341 20.2099 24.5018 20.3114C24.8062 20.7849 24.7047 21.4952 24.2989 21.8334C24.1974 21.9349 24.1974 22.0702 24.265 22.2055C24.3327 22.307 24.468 22.3408 24.6033 22.2393ZM10.6341 22.104C9.95768 21.7996 9.72091 20.954 10.1606 20.3452C10.2283 20.2437 10.1944 20.0746 10.093 20.007C9.9915 19.9393 9.82238 19.9731 9.75474 20.0746C9.14591 20.954 9.48415 22.1378 10.4312 22.5775C10.5665 22.6452 10.7018 22.5775 10.7694 22.4423C10.8371 22.307 10.7694 22.1378 10.6341 22.104ZM11.1415 22.5775C10.9724 22.7467 11.0739 23.0173 11.3106 23.0173C11.4266 23.0173 11.4928 22.9427 11.5307 22.9001C11.537 22.893 11.5426 22.8868 11.5474 22.882L11.3783 22.7128L11.1415 22.5775Z" fill="white" />
</g>
<defs>
<clipPath id="clip0_2008_1167">
<rect width="25" height="37" fill="white" />
</clipPath>
</defs>
</svg>`,
  iconSize: [25, 32],
  className: "marker-icon",
});

export const ObservationPostMarker = ({ activeObservationPostMarker }) => {
  return (
    <>
      {initialObservationPost.map((observationPost) =>
        activeObservationPostMarker ? (
          <Marker
            key={observationPost.properties.id}
            position={[
              Number(observationPost.geometry.coordinates[1]),
              Number(observationPost.geometry.coordinates[0]),
            ]}
            icon={markerObservationPost}
          >
            <Popup className="m-0">
              <Card>
                <CardHeader className="rounded-t-lg bg-[#FFA40B] p-0">
                  <h3 className="p-2 text-center text-sm font-semibold text-white">
                    Pos Pengamatan {""}
                    {observationPost.properties.pos_pengamatan.nama ?? "-"}
                  </h3>
                </CardHeader>
                <CardContent className="p-2">
                  <div className="mb-1.5 flex items-center justify-between gap-x-3">
                    <h5 className="text-sm font-semibold text-gray-600">
                      {`${
                        observationPost.properties.tanggal
                          ? formatDate(
                              observationPost.properties.tanggal,
                              "dd MMMM yyy",
                            )
                          : "-"
                      } | ${observationPost.properties.jam ?? "-"}
                      `}
                    </h5>
                    {/* Status */}
                    {observationPost.properties.status_siaga ? (
                      <StatusBadge
                        status={observationPost.properties.status_siaga}
                      />
                    ) : (
                      "-"
                    )}
                  </div>

                  <h4 className="mb-1.5 text-sm font-semibold text-gray-400">
                    {observationPost.properties.cuaca.nama ?? "-"}
                  </h4>
                  <div className="flex items-center">
                    <FloodIcon className="h-auto w-5 text-primary" />
                    <h5 className="ml-2 text-sm font-semibold text-gray-400">
                      {observationPost.properties.ketinggian !== null &&
                      observationPost.properties.ketinggian !== undefined
                        ? observationPost.properties.ketinggian + " cm"
                        : "-"}
                    </h5>
                  </div>
                </CardContent>
              </Card>
            </Popup>
          </Marker>
        ) : null,
      )}
    </>
  );
};
